import torch
import torch.nn as nn
from mnist_ternary import TernaryMNIST  # Import model structure
from ternary_ops import quantize
import os

# Load Model
model = TernaryMNIST()
model.load_state_dict(torch.load("experiments/python/mnist_ternary.pth"))
model.eval()

def export_layer(layer, name, f):
    weights = quantize(layer.weight).int().cpu().numpy()
    bias = layer.bias.data.int().cpu().numpy() if layer.bias is not None else None
    
    rows, cols = weights.shape
    print(f"Exporting {name}: {rows}x{cols}")
    
    # Helix9 Vector Unit works best with Column-Major or Row-Major?
    # VEC.SAT.MAC takes Input Page and Weight Page.
    # We essentially do Matrix-Vector mult: y = Wx + b
    # For neuron i: y_i = dot(W[i, :], x) + b_i
    # So we need row i of W to be essentially a page (or part of it).
    # Helix Page is 256 words.
    # Layer 1: 784 inputs. We need multiple pages for inputs?
    # Or we process in chunks?
    # Our design goal for this experiment: Simplification.
    # Let's export as linear arrays and let the ASM handle layout.
    
    f.write(f"; Layer {name} Weights ({rows}x{cols})\n")
    f.write(f"{name}_weights:\n")
    
    # Export row by row
    for r in range(rows):
        f.write(f"    .DAT ")
        row_vals = [str(x) for x in weights[r]]
        f.write(" ".join(row_vals))
        f.write("\n")
        
        # Pad to 256-word boundary
        remainder = cols % 256
        if remainder != 0:
            pad_needed = 256 - remainder
            if pad_needed > 0:
                f.write(f"    .DAT ")
                zeros = ["0"] * pad_needed
                f.write(" ".join(zeros))
                f.write(f" ; Padding ({pad_needed})\n")
        
    if bias is not None:
        f.write(f"; Layer {name} Bias ({rows})\n")
        f.write(f"{name}_bias:\n")
        f.write(f"    .DAT ")
        bias_vals = [str(x) for x in bias]
        f.write(" ".join(bias_vals))
        f.write("\n")

output_path = "experiments/tnn/mnist_weights.hasm"
if not os.path.exists("experiments/tnn"):
    os.makedirs("experiments/tnn")
    
with open(output_path, "w") as f:
    f.write("; Helix9 Ternary MNIST Weights\n")
    f.write("; Generated by export_helix.py\n\n")
    
    export_layer(model.fc1, "fc1", f)
    export_layer(model.fc2, "fc2", f)

print(f"Exported to {output_path}")
